#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-sms-notification-fix.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "========================================"
echo "üöÄ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô SMS"
echo "========================================"
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

SSH_HOST="ubuntu@193.111.11.98"
SSH_PORT="3022"
BACKEND_DIR="/root/vazifa/backend"

echo "üì° –°–µ—Ä–≤–µ—Ä: ${SSH_HOST}:${SSH_PORT}"
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${BACKEND_DIR}"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –ø–æ SSH
run_ssh() {
    ssh -p ${SSH_PORT} ${SSH_HOST} "$1"
}

echo "----------------------------------------"
echo "1Ô∏è‚É£ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo "----------------------------------------"

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
scp -P ${SSH_PORT} \
    backend/diagnose-sms-settings.js \
    backend/fix-sms-settings.js \
    backend/test-task-notification-sms.js \
    ${SSH_HOST}:${BACKEND_DIR}/

echo -e "${GREEN}‚úÖ –°–∫—Ä–∏–ø—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã${NC}"
echo ""

echo "----------------------------------------"
echo "2Ô∏è‚É£ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
echo "----------------------------------------"

run_ssh "cd ${BACKEND_DIR} && node diagnose-sms-settings.js"

echo ""
echo "----------------------------------------"
echo "3Ô∏è‚É£ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ SMS..."
echo "----------------------------------------"

read -p "$(echo -e ${YELLOW}–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫? [y/N]:${NC} )" -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    run_ssh "cd ${BACKEND_DIR} && node fix-sms-settings.js"
    echo -e "${GREEN}‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã${NC}"
else
    echo -e "${YELLOW}‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ${NC}"
fi

echo ""
echo "----------------------------------------"
echo "4Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS..."
echo "----------------------------------------"

read -p "$(echo -e ${YELLOW}–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ SMS? [y/N]:${NC} )" -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    run_ssh "cd ${BACKEND_DIR} && node test-task-notification-sms.js"
    echo -e "${GREEN}‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω${NC}"
    echo ""
    echo -e "${YELLOW}üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ SMS:${NC}"
    echo "   - –õ–∞—Ç–∏—Ñ –†–∞—á–∞–±–æ–≤: +992557777509"
    echo "   - Rashid Khan: (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ª–æ–≥–∞—Ö)"
else
    echo -e "${YELLOW}‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ${NC}"
fi

echo ""
echo "----------------------------------------"
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ SMS..."
echo "----------------------------------------"

read -p "$(echo -e ${YELLOW}–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ SMS –ª–æ–≥–∏? [y/N]:${NC} )" -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 SMS –ª–æ–≥–æ–≤:"
    run_ssh "mongosh vazifa --quiet --eval 'db.smslogs.find().sort({createdAt: -1}).limit(10).pretty()'"
else
    echo -e "${YELLOW}‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ${NC}"
fi

echo ""
echo "========================================"
echo "‚úÖ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û"
echo "========================================"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö SMS"
echo "   2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
echo "   3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SMS –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á"
echo ""
echo "üîç –î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
echo "   ssh ${SSH_HOST} -p${SSH_PORT}"
echo "   cd ${BACKEND_DIR}"
echo "   pm2 logs backend"
echo ""
echo "========================================"
