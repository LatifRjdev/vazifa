/**
 * Password Reset Script
 * Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 * 
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
 * node reset-user-password.js <email> <new_password>
 * 
 * ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:
 * node reset-user-password.js mahmasharif.jalilov@bgroup.tj xzibit2000
 */

import mongoose from 'mongoose';
import bcrypt from 'bcrypt';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Load environment variables
dotenv.config({ path: join(__dirname, '.env') });

// Import User model
import './models/users.js';
const User = mongoose.model('User');

// ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº MongoDB
async function connectDB() {
  try {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğº MongoDB');
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº MongoDB:', error.message);
    process.exit(1);
  }
}

// Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
async function resetUserPassword(email, newPassword) {
  try {
    console.log(`\nğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ email: ${email}...`);
    
    // ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    const user = await User.findOne({ email });
    
    if (!user) {
      console.log('âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      console.log(`   Email "${email}" Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…`);
      return false;
    }
    
    console.log('\nğŸ“‹ ĞĞ°Ğ¹Ğ´ĞµĞ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ:');
    console.log(`   Ğ˜Ğ¼Ñ: ${user.name}`);
    console.log(`   Email: ${user.email}`);
    console.log(`   Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: ${user.phoneNumber || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½'}`);
    console.log(`   Ğ Ğ¾Ğ»ÑŒ: ${user.role}`);
    console.log(`   Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½: ${user.createdAt.toLocaleString('ru-RU')}`);
    
    console.log(`\nğŸ” Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ...`);
    
    // Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(newPassword, salt);
    
    console.log('âœ… ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ·Ğ°Ñ…ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ (Ğ±ĞµĞ· Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸)
    await User.updateOne(
      { _id: user._id },
      { $set: { password: hashedPassword } }
    );
    
    console.log('\nâœ… ĞŸĞĞ ĞĞ›Ğ¬ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ Ğ˜Ğ—ĞœĞ•ĞĞ•Ğ!');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`ğŸ“§ Email: ${user.email}`);
    console.log(`ğŸ”‘ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ: ${newPassword}`);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('\nğŸ’¡ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼');
    
    return true;
    
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ±Ñ€Ğ¾ÑĞµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ:', error.message);
    return false;
  }
}

// ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ help
function showHelp() {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ” Password Reset Script                         â•‘
â•‘           Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞĞ˜Ğ•:

  node reset-user-password.js <email> <new_password>

ğŸ“ ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ«:

  # Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  node reset-user-password.js user@example.com newPassword123
  
  # Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ñ ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†ĞµĞ¹
  node reset-user-password.js admin@site.tj ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ2024

âš ï¸  Ğ’ĞĞ–ĞĞ:
  - Email Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
  - ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ñ…ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ñ bcrypt
  - ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¼ĞµĞ½Ñ‹ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ

`);
}

// Main Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
async function main() {
  const email = process.argv[2];
  const newPassword = process.argv[3];
  
  if (!email || !newPassword) {
    showHelp();
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹\n');
    console.log('ğŸ’¡ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: node reset-user-password.js <email> <new_password>\n');
    process.exit(1);
  }
  
  console.log('â•'.repeat(60));
  console.log('ğŸ” Password Reset Script');
  console.log('â•'.repeat(60));
  
  await connectDB();
  
  const success = await resetUserPassword(email, newPassword);
  
  await mongoose.connection.close();
  console.log('\nğŸ‘‹ ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ¾Ñ‚ MongoDB\n');
  
  process.exit(success ? 0 : 1);
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº
main().catch((error) => {
  console.error('âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:', error);
  process.exit(1);
});
