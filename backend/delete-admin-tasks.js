/**
 * Delete All Tasks Created by admin@vazifa2.com
 * Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ´Ğ°Ñ‡, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ admin@vazifa2.com
 * 
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
 * node delete-admin-tasks.js
 */

import mongoose from 'mongoose';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Load environment variables
dotenv.config({ path: join(__dirname, '.env') });

// Import models
import Task from './models/tasks.js';
import User from './models/users.js';
import Comment from './models/comments.js';
import Response from './models/responses.js';
import ActivityLog from './models/activity-logs.js';

const ADMIN_EMAIL = 'admin@vazifa2.com';

// ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº MongoDB
async function connectDB() {
  try {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğº MongoDB');
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº MongoDB:', error.message);
    process.exit(1);
  }
}

// Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡
async function deleteAdminTasks() {
  try {
    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘     ğŸ—‘ï¸  Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ admin@vazifa2.com    â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    // 1. ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ admin@vazifa2.com
    console.log(`ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${ADMIN_EMAIL}...`);
    const adminUser = await User.findOne({ email: ADMIN_EMAIL });

    if (!adminUser) {
      console.log(`âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ${ADMIN_EMAIL} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…`);
      return;
    }

    console.log(`âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½:`);
    console.log(`   ID: ${adminUser._id}`);
    console.log(`   Ğ˜Ğ¼Ñ: ${adminUser.name}`);
    console.log(`   Email: ${adminUser.email}`);
    console.log(`   Ğ Ğ¾Ğ»ÑŒ: ${adminUser.role}`);

    // 2. ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼
    console.log(`\nğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ·Ğ°Ğ´Ğ°Ñ‡, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ ${ADMIN_EMAIL}...`);
    const tasks = await Task.find({ createdBy: adminUser._id }).sort({ createdAt: -1 });

    if (tasks.length === 0) {
      console.log(`âœ… Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹. Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒĞ¶Ğµ Ñ‡Ğ¸ÑÑ‚Ğ°Ñ.`);
      return;
    }

    console.log(`\nğŸ“Š ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡: ${tasks.length}`);
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

    // 3. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 10 Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°
    console.log('ğŸ“‹ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 10):');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    const displayTasks = tasks.slice(0, 10);
    displayTasks.forEach((task, index) => {
      console.log(`${index + 1}. "${task.title}"`);
      console.log(`   ID: ${task._id}`);
      console.log(`   Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${task.status}`);
      console.log(`   ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: ${task.priority}`);
      console.log(`   Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ°: ${task.createdAt.toLocaleString('ru-RU')}`);
      console.log(`   ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸: ${task.comments.length}`);
      console.log(`   ĞÑ‚Ğ²ĞµÑ‚Ñ‹: ${task.responses.length}`);
      console.log(`   ĞŸĞ¾Ğ´Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸: ${task.subtasks.length}`);
      console.log('');
    });

    if (tasks.length > 10) {
      console.log(`   ... Ğ¸ ĞµÑ‰Ğµ ${tasks.length - 10} Ğ·Ğ°Ğ´Ğ°Ñ‡(Ğ¸)\n`);
    }

    // 4. ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
    console.log('ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    const taskIds = tasks.map(task => task._id);
    
    const commentsCount = await Comment.countDocuments({ task: { $in: taskIds } });
    const responsesCount = await Response.countDocuments({ task: { $in: taskIds } });
    const activityLogsCount = await ActivityLog.countDocuments({ resourceId: { $in: taskIds } });

    console.log(`   Ğ—Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:        ${tasks.length}`);
    console.log(`   ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸:               ${commentsCount}`);
    console.log(`   ĞÑ‚Ğ²ĞµÑ‚Ñ‹:                    ${responsesCount}`);
    console.log(`   Ğ›Ğ¾Ğ³Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸:           ${activityLogsCount}`);
    console.log('');

    const totalRecords = tasks.length + commentsCount + responsesCount + activityLogsCount;
    console.log(`   ğŸ“¦ Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹:          ${totalRecords}`);

    // 5. ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ—‘ï¸  ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ...\n');

    let deletedTasks = 0;
    let deletedComments = 0;
    let deletedResponses = 0;
    let deletedLogs = 0;

    // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¿Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¸ pre-hooks
    for (let i = 0; i < tasks.length; i++) {
      const task = tasks[i];
      
      // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 10 Ğ·Ğ°Ğ´Ğ°Ñ‡
      if ((i + 1) % 10 === 0 || i === 0) {
        console.log(`   Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ${i + 1}/${tasks.length}...`);
      }

      // ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾
      const taskComments = await Comment.countDocuments({ task: task._id });
      const taskResponses = await Response.countDocuments({ task: task._id });
      const taskLogs = await ActivityLog.countDocuments({ resourceId: task._id });

      // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ (pre-hook ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
      await task.deleteOne();

      deletedTasks++;
      deletedComments += taskComments;
      deletedResponses += taskResponses;
      deletedLogs += taskLogs;
    }

    // 6. Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!\n');
    console.log('ğŸ“Š Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    console.log(`   âœ“ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡:           ${deletedTasks}`);
    console.log(`   âœ“ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ²:    ${deletedComments}`);
    console.log(`   âœ“ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²:         ${deletedResponses}`);
    console.log(`   âœ“ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¾Ğ²:           ${deletedLogs}`);
    console.log('');
    console.log(`   ğŸ¯ Ğ’ÑĞµĞ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹:  ${deletedTasks + deletedComments + deletedResponses + deletedLogs}`);
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  } catch (error) {
    console.error('\nâŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡:', error.message);
    console.error(error.stack);
    throw error;
  }
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
async function main() {
  try {
    await connectDB();
    await deleteAdminTasks();
    
    await mongoose.connection.close();
    console.log('ğŸ‘‹ ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ¾Ñ‚ MongoDB\n');
    process.exit(0);
  } catch (error) {
    console.error('âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:', error);
    process.exit(1);
  }
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº
main();
