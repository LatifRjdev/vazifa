#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Vazifa —á–µ—Ä–µ–∑ Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""

# SSH –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
SSH_USER="ubuntu"
SSH_HOST="193.111.11.98"
SSH_PORT="3022"
SSH_PATH="/var/www/vazifa"

echo -e "${BLUE}–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...${NC}"
echo ""

ssh -p $SSH_PORT $SSH_USER@$SSH_HOST << 'ENDSSH'
set -e  # Exit on error

echo "========================================="
echo "  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub"
echo "========================================="
echo ""

cd /var/www/vazifa

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ remote URL –Ω–∞ HTTPS..."
git remote set-url origin https://github.com/LatifRjdev/vazifa.git
echo "‚úì Remote URL –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ HTTPS"
echo ""

echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub..."
git fetch origin main
echo "‚úì –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã"
echo ""

echo "üîÑ –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
git reset --hard HEAD
echo "‚úì –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã"
echo ""

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git pull origin main
echo "‚úì –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω"
echo ""

echo "========================================="
echo "  –°–±–æ—Ä–∫–∞ frontend"
echo "========================================="
echo ""

cd frontend

echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)..."
npm install
echo "‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build
echo "‚úì –ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω"
echo ""

cd ..

echo "========================================="
echo "  –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
echo "========================================="
echo ""

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ vazifa-frontend..."
pm2 restart vazifa-frontend

echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2..."
pm2 save

echo ""
echo "üìä –°—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
pm2 list

echo ""
echo "========================================="
echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
echo "========================================="
echo ""
echo "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:"
git log -1 --pretty=format:"%h - %an, %ar : %s"
echo ""
echo ""

ENDSSH

if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}================================================${NC}"
    echo -e "${GREEN}  ‚úì –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
    echo -e "${GREEN}================================================${NC}"
    echo ""
    echo -e "${BLUE}–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:${NC}"
    echo -e "  ‚úì –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ GitHub"
    echo -e "  ‚úì Frontend –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω"
    echo -e "  ‚úì PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"
    echo ""
    echo -e "${BLUE}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:${NC}"
    echo -e "  ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
    echo -e "  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–≤–∏–≥–∞—Ü–∏—é (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø—Ä–æ—Ñ–∏–ª—å, –∑–∞–¥–∞—á–∏)"
    echo -e "  ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    echo ""
else
    echo ""
    echo -e "${RED}================================================${NC}"
    echo -e "${RED}  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏${NC}"
    echo -e "${RED}================================================${NC}"
    echo ""
    echo -e "${YELLOW}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:${NC}"
    echo -e "  ssh -p $SSH_PORT $SSH_USER@$SSH_HOST 'pm2 logs vazifa-frontend'"
    echo ""
fi
