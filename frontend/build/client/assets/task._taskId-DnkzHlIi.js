import{w as We}from"./with-props-DyG_vBPJ.js";import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{a as d,C as He,s as Ke,q as be}from"./chunk-D4RADZKF-By21buN-.js";import{u as ce}from"./useQuery-CkwzADaB.js";import{b as Qe,k as Ge,f as de,u as Je,p as ae}from"./fetch-utils-CEdl9sdl.js";import{u as ee}from"./useMutation-CUJSGQ7R.js";import{d as Ze,e as Xe,f as Ye,g as es,h as ss,i as ts,j as as,k as rs,l as ns}from"./use-task-ClqRGOoq.js";import{L as xe}from"./loader-B2rr_xqw.js";import{B as X}from"./badge-BR4L36Rg.js";import{B as h}from"./button-CYnDp3Q-.js";import{C as ke,a as we,d as Se,b as is}from"./card-DunmZ-Mm.js";import{I as se}from"./input-BPm_T_uW.js";import{S as ls,a as os,b as cs,c as ds,d as le}from"./select-CDLpyc4Q.js";import{X as he,D as Pe,a as Fe,b as Ue,c as Re,f as ms}from"./dialog-Bw6wHjQP.js";import{f as oe}from"./date-utils-BYRQ6yq9.js";import{g as Ce,a as us}from"./translations-D806p-9r.js";import{u as pe}from"./auth-context-B5vrc64i.js";import{t as m}from"./index-CNgNZYQm.js";import{L as fe}from"./loader-circle-DPdm6C66.js";import{c as P}from"./createLucideIcon-DYOGCEiU.js";import{T as ge,S as xs,P as hs}from"./textarea-2qDDOoVt.js";import{A as re,a as ne,b as ie}from"./avatar-B8lmOvvi.js";import{S as Ee}from"./scroll-area-N5jEjwpk.js";import{S as Te}from"./separator-CWSlA8lv.js";import{P as ps,a as fs,b as gs,r as js}from"./popover-Ct-mlSgl.js";import{a as je}from"./index-DgMzxt3E.js";import{f as Ne}from"./formatDistanceToNow-DfO8AiA2.js";import{D as me}from"./download-D4F4ZKAG.js";import{E as De}from"./eye-BcJvAFHL.js";import{C as Ns}from"./circle-check-c3MMHh6m.js";import{C as ue}from"./circle-check-big-CiMFBpoa.js";import{A as Me}from"./arrow-left-BZk8-X3l.js";import{S as _e}from"./star-Cq7vPmKH.js";import{U as vs}from"./user-DIG-VwFC.js";import{U as ys}from"./users-C3qiH94-.js";import{C as bs}from"./calendar-Dcbq6X4X.js";import{C as ze}from"./clock-DtXE6-Nx.js";import"./differenceInCalendarDays-D7TXt3rl.js";import"./utils-DIzSUSji.js";import"./index-CnVBUu3y.js";import"./index-BdQq_4o_.js";import"./index-wu72o1Zw.js";import"./index-BIYj4ebj.js";import"./index-DTIwNWd2.js";import"./index-BhFca_hj.js";import"./Combination-BUzufNIs.js";import"./index-Dspms17g.js";import"./en-US-DuGUIuVI.js";import"./endOfMonth-B9jd4p3w.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ks=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],ws=P("archive",ks);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ss=[["path",{d:"M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z",key:"1b4qmf"}],["path",{d:"M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2",key:"i71pzd"}],["path",{d:"M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2",key:"10jefs"}],["path",{d:"M10 6h4",key:"1itunk"}],["path",{d:"M10 10h4",key:"tcdvrf"}],["path",{d:"M10 14h4",key:"kelpxr"}],["path",{d:"M10 18h4",key:"1ulq68"}]],Cs=P("building-2",Ss);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ms=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],_s=P("cloud-upload",Ms);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zs=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],As=P("eye-off",zs);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ps=[["path",{d:"M12.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v9.5",key:"1couwa"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M13.378 15.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1y4qbx"}]],Fs=P("file-pen",Ps);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Us=[["path",{d:"M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z",key:"i9b6wo"}],["line",{x1:"4",x2:"4",y1:"22",y2:"15",key:"1cm3nv"}]],Rs=P("flag",Us);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=[["path",{d:"M2 11.5V5a2 2 0 0 1 2-2h3.9c.7 0 1.3.3 1.7.9l.8 1.2c.4.6 1 .9 1.7.9H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-9.5",key:"a8xqs0"}],["path",{d:"M11.378 13.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1saktj"}]],Ts=P("folder-pen",Es);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ds=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],$s=P("folder-plus",Ds);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bs=[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]],qs=P("link-2",Bs);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]],Ls=P("log-in",Is);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Os=[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]],Vs=P("message-square",Os);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ws=[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],$e=P("mic",Ws);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hs=[["path",{d:"M13.234 20.252 21 12.3",key:"1cbrk9"}],["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486",key:"1pkts6"}]],te=P("paperclip",Hs);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ks=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Qs=P("smile",Ks);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gs=[["path",{d:"M21 10.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.5",key:"1uzm8b"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Ae=P("square-check-big",Gs);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Js=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],ve=P("square-pen",Js);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zs=[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]],Xs=P("upload",Zs);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ys=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],et=P("user-minus",Ys);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],tt=P("user-plus",st),at=({title:i,taskId:t})=>{const[o,v]=d.useState(!1),[p,M]=d.useState(i),{mutate:y,isPending:x}=Ze(),S=async()=>{y({taskId:t,title:p},{onSuccess:()=>{m.success("Task title updated successfully"),v(!1)},onError:j=>{m.error("Failed to update task title"),console.error(j)}})};return e.jsxs("div",{className:"flex items-center gap-2",children:[o?e.jsx(se,{className:"text-xl font-semibold w-full min-w-3xl",value:p,onChange:j=>M(j.target.value),disabled:x}):e.jsx("h2",{className:"text-xl flex-1 font-semibold",children:i}),o?e.jsx(h,{className:"py-0",size:"sm",disabled:x,onClick:S,children:x?e.jsx(fe,{className:"w-4 h-4 animate-spin"}):"Save"}):e.jsx(ve,{className:"w-3 h-3 cursor-pointer",onClick:()=>v(!0)})]})},rt=({description:i,taskId:t})=>{const[o,v]=d.useState(!1),[p,M]=d.useState(i),{mutate:y,isPending:x}=Xe(),S=async()=>{y({taskId:t,description:p},{onSuccess:()=>{m.success("Task description updated successfully"),v(!1)},onError:j=>{m.error("Failed to update task description"),console.error(j)}})};return e.jsxs("div",{className:"flex gap-2",children:[o?e.jsx(ge,{className:"w-full min-w-3xl",value:p,onChange:j=>M(j.target.value),disabled:x}):e.jsx("div",{className:"bg-muted/50 p-4 rounded-md text-sm md:text-base text-pretty text-muted-foreground",children:i}),o?e.jsx(h,{className:"py-0",size:"sm",disabled:x,onClick:S,children:x?e.jsx(fe,{className:"w-4 h-4 animate-spin"}):"Save"}):e.jsx(ve,{className:"min-w-4 min-h-4 w=4 h-4 cursor-pointer",onClick:()=>v(!0)})]})},nt=({attachments:i,taskId:t})=>{const[o,v]=d.useState(!1),[p,M]=d.useState("upload"),[y,x]=d.useState(""),[S,j]=d.useState(""),[u,k]=d.useState(null),[F,U]=d.useState(!1),[L,_]=d.useState(0),[$,g]=d.useState(""),[O,I]=d.useState(""),{mutate:n,isPending:E}=Ye(),V=()=>{x(""),j(""),k(null),U(!1),_(0),g(""),I("")},Q=async()=>{if(g(""),I(""),p==="upload"){if(!u){g("Please select a file to upload.");return}if(u.size>1024*1024){g("File size must be less than 1MB.");return}U(!0),_(0);try{const N="https://api.vazifa.online/api-v1/upload",B=new FormData;B.append("file",u);const W=localStorage.getItem("token"),C=await Qe.post(N,B,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${W}`},onUploadProgress:T=>{T.total&&_(Math.round(T.loaded*100/T.total))}}),a=C.data.data.secure_url,f=C.data.data.mimetype||C.data.data.resource_type,w=C.data.data.bytes,z=C.data.data.original_filename;n({taskId:t,attachment:{fileName:z,fileUrl:a,fileType:f,fileSize:w}},{onSuccess:()=>{I("File uploaded successfully!"),setTimeout(()=>{V(),v(!1)},3e3)},onError:T=>{g("Upload failed. Please try again."),console.error(T)}})}catch{g("Upload failed. Please try again.")}finally{U(!1),_(0)}}else{if(!y||!S){g("Please provide both file name and URL.");return}n({taskId:t,attachment:{fileName:y,fileUrl:S,fileType:"URL",fileSize:0}},{onSuccess:()=>{I("Attachment added by URL!"),setTimeout(()=>{V(),v(!1)},3e3)},onError:N=>{g("Upload failed. Please try again."),console.error(N)}})}};return e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"text-sm font-medium text-muted-foreground flex items-center",children:[e.jsx(te,{className:"h-4 w-4 mr-2"})," Вложения"]}),e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>v(!o),children:[e.jsx(te,{className:"h-4 w-4 mr-1"}),"Добавить"]})]}),o&&e.jsxs("div",{className:"bg-muted/30 p-6 rounded-xl mb-4 shadow-lg border border-muted/50",children:[e.jsxs("div",{className:"flex mb-4 border-b border-muted/40",children:[e.jsxs("button",{className:`flex-1 py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-150 ${p==="upload"?"bg-background text-primary":"text-muted-foreground hover:text-primary"}`,onClick:()=>M("upload"),type:"button",children:[e.jsx(_s,{className:"inline h-4 w-4 mr-1"})," Загрузить"]}),e.jsxs("button",{className:`flex-1 py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-150 ${p==="url"?"bg-background text-primary":"text-muted-foreground hover:text-primary"}`,onClick:()=>M("url"),type:"button",children:[e.jsx(qs,{className:"inline h-4 w-4 mr-1"})," По URL-адресу"]})]}),e.jsxs("div",{className:"grid gap-4",children:[p==="upload"?e.jsxs(e.Fragment,{children:[e.jsx(se,{type:"file",accept:"*",onChange:N=>{var B;return k(((B=N.target.files)==null?void 0:B[0])||null)},disabled:F||E}),u&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Выбрано: ",e.jsx("span",{className:"font-medium",children:u.name})," (",Math.round(u.size/1024)," KB)"]}),F&&e.jsx("div",{className:"w-full bg-muted rounded h-2 mt-2 overflow-hidden",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded",style:{width:`${L}%`}})})]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{placeholder:"File name",value:y,onChange:N=>x(N.target.value),disabled:F||E}),e.jsx(se,{placeholder:"File URL",value:S,onChange:N=>j(N.target.value),disabled:F||E})]}),$&&e.jsx("div",{className:"text-sm text-red-600",children:$}),O&&e.jsx("div",{className:"text-sm text-green-600",children:O}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{v(!1),V()},disabled:F||E,children:"Отмена"}),e.jsx(h,{size:"sm",onClick:Q,disabled:F||E||(p==="upload"?!u:!y||!S),children:F||E?"Uploading...":"Добавить вложение"})]})]})]}),e.jsx("div",{className:"space-y-2",children:i&&i.length>0?i.map((N,B)=>e.jsxs("div",{className:"flex items-center justify-between p-2 hover:bg-muted rounded-md transition-colors duration-150",children:[e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsx("div",{className:"bg-blue-600/10 p-2 rounded mr-2",children:e.jsx(te,{className:"h-4 w-4 text-blue-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:N.fileName}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[N.fileType," •"," ",N.fileSize>0?Math.round(N.fileSize/1024)+" KB":"Unknown file size"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("a",{href:N.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 text-xs font-medium",children:"Открыть"}),e.jsx("a",{href:N.fileUrl,download:N.fileName,className:"text-green-600 hover:text-green-800 text-xs font-medium",children:"Скачать"})]})]},N._id||B)):e.jsx("div",{className:"text-sm text-muted-foreground px-2",children:"Без вложений"})})]})},it=["👍","👎","❤️","😂","😮","😢","🎉","🚀","🔥","🔔"],lt=({taskId:i,members:t})=>{const{user:o}=pe(),[v,p]=d.useState(!1),[M,y]=d.useState(""),[x,S]=d.useState({top:0,left:0}),[j,u]=d.useState(0),k=d.useRef(null),F=d.useRef(null),[U,L]=d.useState(""),[_,$]=d.useState([]),[g,O]=d.useState(!1),[I,n]=d.useState(!1),[E,V]=d.useState(null),{data:Q,isPending:N}=es(i),{mutate:B,isPending:W}=ss(),{mutate:C,isPending:a}=ts(),f=t.filter(s=>{var l;return(l=s==null?void 0:s.name)==null?void 0:l.toLowerCase().includes(M.toLowerCase())}),w=s=>{const l=s.target.value;L(l);const c=s.target.selectionStart||0;u(c);const b=l.slice(0,c),R=b.lastIndexOf("@");if(R!==-1&&(R===0||l[R-1]===" ")){const Z=b.slice(R+1);if(y(Z),p(!0),k.current){const q=T(k.current,c);S({top:q.top+20,left:q.left})}}else p(!1)},z=s=>{if(k.current){const l=U,c=j,R=l.slice(0,c).lastIndexOf("@");if(R!==-1){const Z=l.slice(0,R)+`@${s.name} `+l.slice(c);L(Z),p(!1),setTimeout(()=>{if(k.current){k.current.focus();const q=R+s.name.length+2;k.current.setSelectionRange(q,q)}},0)}}},T=(s,l)=>{const{offsetLeft:c,offsetTop:b}=s;return{top:b+20,left:c+l*8}},G=()=>{if(!U.trim()&&_.length===0){m.error("Добавьте текст или прикрепите файл");return}B({taskId:i,text:U,attachments:_},{onSuccess:()=>{L(""),$([]),m.success("Ответ добавлен успешно")},onError:s=>{m.error("Не удалось добавить ответ"),console.error(s)}})},H=async s=>{if(s.length===0)return;O(!0);const l=[];for(const c of Array.from(s)){if(c.size>50*1024*1024){m.error(`Файл ${c.name} превышает лимит в 50MB`);continue}try{const b=new FormData;b.append("file",c);const R=await fetch("https://api.vazifa.online/api-v1/upload",{method:"POST",body:b,headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!R.ok)throw new Error("Upload failed");const Z=await R.json();l.push({fileName:c.name,fileUrl:Z.data.secure_url,fileType:c.type,fileSize:c.size})}catch(b){console.error("Upload error:",b),m.error(`Не удалось загрузить файл ${c.name}`)}}$(c=>[...c,...l]),O(!1)},Y=s=>{s.target.files&&H(s.target.files)},r=s=>{$(l=>l.filter((c,b)=>b!==s))},A=async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){m.error("Ваш браузер не поддерживает запись аудио");return}const s=await navigator.mediaDevices.getUserMedia({audio:!0}),l=new MediaRecorder(s),c=[];l.ondataavailable=b=>{c.push(b.data)},l.onstop=async()=>{const b=new Blob(c,{type:"audio/webm"}),R=new File([b],`voice-${Date.now()}.webm`,{type:"audio/webm"}),Z=new FormData;Z.append("file",R);try{O(!0);const q=await fetch("https://api.vazifa.online/api-v1/upload",{method:"POST",body:Z,headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!q.ok)throw new Error("Upload failed");const Oe=await q.json();$(Ve=>[...Ve,{fileName:"Голосовое сообщение",fileUrl:Oe.data.secure_url,fileType:"audio/webm",fileSize:R.size}]),m.success("Голосовое сообщение добавлено")}catch(q){console.error("Voice upload error:",q),m.error("Не удалось загрузить голосовое сообщение")}finally{O(!1)}s.getTracks().forEach(q=>q.stop())},l.start(),V(l),n(!0),m.success("Запись началась...")}catch(s){console.error("Recording error:",s),s instanceof DOMException?s.name==="NotAllowedError"?m.error("Доступ к микрофону запрещен. Разрешите доступ к микрофону в настройках браузера."):s.name==="NotFoundError"?m.error("Микрофон не найден. Подключите микрофон и попробуйте снова."):s.name==="NotReadableError"?m.error("Микрофон занят другим приложением. Закройте другие приложения и попробуйте снова."):s.name==="OverconstrainedError"?m.error("Микрофон не поддерживает требуемые настройки."):s.name==="SecurityError"?m.error("Запись аудио заблокирована по соображениям безопасности. Используйте HTTPS соединение."):m.error("Не удалось начать запись. Проверьте подключение микрофона."):m.error("Не удалось начать запись. Проверьте подключение микрофона.")}},D=()=>{E&&I&&(E.stop(),n(!1),V(null),m.success("Запись остановлена"))},K=s=>{if(s===0)return"0 Bytes";const l=1024,c=["Bytes","KB","MB","GB"],b=Math.floor(Math.log(s)/Math.log(l));return parseFloat((s/Math.pow(l,b)).toFixed(2))+" "+c[b]},J=s=>s.startsWith("image/")?"🖼️":s.startsWith("video/")?"🎥":s.startsWith("audio/")?"🎵":s.includes("pdf")?"📄":s.includes("word")?"📝":s.includes("excel")||s.includes("spreadsheet")?"📊":"📎";d.useEffect(()=>{const s=()=>p(!1);return document.addEventListener("click",s),()=>document.removeEventListener("click",s)},[]);const Be=s=>{v&&s.key==="Escape"&&(p(!1),s.preventDefault())},qe=s=>s.split(/(@[\w\s]+)/g).map((c,b)=>{if(c.startsWith("@")){const R=c.slice(1).trim();if(t.some(q=>q.name===R))return e.jsx("span",{className:"bg-blue-600/10 text-blue-600 px-1 rounded",children:c},b)}return c}),ye=(s,l)=>{C({commentId:s,emoji:l},{onSuccess:()=>{m.success("Reaction added successfully")},onError:c=>{m.error("Failed to add reaction"),console.error(c)}})},Ie=(s=[])=>{const l={};return s.forEach(c=>{l[c.emoji]||(l[c.emoji]=0),l[c.emoji]++}),l},Le=(s=[],l)=>{const c=o==null?void 0:o._id;return s.some(b=>b.user._id===c&&b.emoji===l)};return N?e.jsx(xe,{message:"Loading comments..."}):e.jsxs("div",{className:"bg-card rounded-lg p-6 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Комментарии"}),e.jsx(Ee,{className:"h-[300px] mb-4",children:e.jsx("div",{className:"space-y-4",children:Q.length>0?Q.map(s=>e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(re,{className:"h-8 w-8",children:[e.jsx(ne,{src:s.author.profilePicture||je(s.author.name)}),e.jsx(ie,{children:s.author.name?s.author.name.charAt(0):"?"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:s.author.name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Ne(new Date(s.createdAt),{addSuffix:!0})})]}),s.text&&e.jsx("p",{className:"text-sm",children:qe(s.text)}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:s.attachments.map((l,c)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted/50 rounded",children:[e.jsx("span",{className:"text-lg",children:J(l.fileType)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:l.fileName}),e.jsx("p",{className:"text-xs text-muted-foreground",children:K(l.fileSize)})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>window.open(l.fileUrl,"_blank"),children:e.jsx(me,{size:14})})]},c))}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[s.reactions&&Object.entries(Ie(s.reactions)).map(([l,c])=>e.jsxs("button",{className:`inline-flex items-center text-xs rounded-full px-2 py-1 border cursor-pointer ${Le(s.reactions,l)?"bg-primary/10 border-primary/20":"bg-muted hover:bg-muted/80 border-muted/50"}`,onClick:()=>ye(s._id,l),children:[e.jsx("span",{className:"mr-1",children:l}),e.jsx("span",{children:c})]},l)),e.jsxs(ps,{children:[e.jsx(fs,{asChild:!0,children:e.jsxs("button",{className:"inline-flex items-center text-xs rounded-full px-2 py-1 border border-dashed border-muted-foreground/30 hover:bg-muted/80 cursor-pointer",children:[e.jsx(Qs,{size:12,className:"mr-1"}),e.jsx("span",{children:"Добавить"})]})}),e.jsx(gs,{className:"w-auto p-2",children:e.jsx("div",{className:"flex flex-wrap gap-2 max-w-[200px]",children:it.map(l=>e.jsx("button",{className:"hover:bg-muted p-1 rounded text-lg cursor-pointer",onClick:()=>{ye(s._id,l)},children:l},l))})})]})]})]})]},s._id)):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground text-sm",children:"Нет комментариев"})})})}),e.jsx(Te,{className:"my-4"}),e.jsxs("div",{className:"mt-4 relative",children:[e.jsx(ge,{ref:k,placeholder:"Добавить комментарий... (используйте @, чтобы упомянуть людей)",value:U,onChange:w,onKeyDown:Be,className:"mb-2"}),v&&f.length>0&&e.jsx("div",{className:"absolute z-50 bg-popover border rounded-md shadow-md p-1 w-64",style:{top:x.top,left:x.left,maxHeight:"200px",overflowY:"auto"},onClick:s=>s.stopPropagation(),children:f.map(s=>e.jsxs("div",{className:"flex items-center gap-2 p-2 hover:bg-accent cursor-pointer rounded",onClick:()=>z(s),children:[e.jsxs(re,{className:"h-6 w-6",children:[e.jsx(ne,{src:s.profilePicture}),e.jsx(ie,{children:s.name?s.name.charAt(0):"?"})]}),e.jsx("span",{className:"text-sm",children:s.name})]},s._id))}),_.length>0&&e.jsx("div",{className:"mb-3 space-y-2",children:_.map((s,l)=>e.jsxs("div",{className:"flex items-center justify-between bg-muted p-2 rounded",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:J(s.fileType)}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:s.fileName}),e.jsx("p",{className:"text-xs text-muted-foreground",children:K(s.fileSize)})]})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>r(l),children:e.jsx(he,{size:16})})]},l))}),e.jsx("input",{ref:F,type:"file",multiple:!0,className:"hidden",onChange:Y}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>{var s;return(s=F.current)==null?void 0:s.click()},disabled:g,children:[e.jsx(te,{size:16,className:"mr-1"}),"Файл"]}),e.jsxs(h,{variant:"ghost",size:"sm",onClick:I?D:A,disabled:g,className:I?"text-red-500":"",children:[e.jsx($e,{size:16,className:"mr-1"}),I?"Стоп":"Голос"]}),g&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"Загрузка..."})]}),e.jsx(h,{onClick:G,disabled:W||!U.trim()&&_.length===0,children:W?"Публикуется...":"Опубликовать комментарий"})]})]})]})},ot=({fileName:i,fileUrl:t,fileType:o,fileSize:v})=>{const[p,M]=d.useState(!1),y=u=>{if(u===0)return"0 Bytes";const k=1024,F=["Bytes","KB","MB","GB"],U=Math.floor(Math.log(u)/Math.log(k));return parseFloat((u/Math.pow(k,U)).toFixed(2))+" "+F[U]},x=u=>u.startsWith("image/")?"🖼️":u.startsWith("video/")?"🎥":u.startsWith("audio/")?"🎵":u.includes("pdf")?"📄":u.includes("word")?"📝":u.includes("excel")||u.includes("spreadsheet")?"📊":"📎",S=u=>u.startsWith("image/")||u.startsWith("video/")||u.startsWith("audio/")||u.includes("pdf"),j=()=>o.startsWith("image/")?e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:t,alt:i,className:"max-w-full max-h-[70vh] object-contain"})}):o.startsWith("video/")?e.jsx("div",{className:"flex justify-center",children:e.jsx("video",{src:t,controls:!0,className:"max-w-full max-h-[70vh]",children:"Ваш браузер не поддерживает воспроизведение видео."})}):o.startsWith("audio/")?e.jsx("div",{className:"flex justify-center p-8",children:e.jsx("audio",{src:t,controls:!0,className:"w-full max-w-md",children:"Ваш браузер не поддерживает воспроизведение аудио."})}):o.includes("pdf")?e.jsx("div",{className:"w-full h-[70vh]",children:e.jsx("iframe",{src:t,className:"w-full h-full border-0",title:i,children:e.jsxs("p",{children:["Ваш браузер не поддерживает просмотр PDF файлов."," ",e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",children:"Скачать файл"})]})})}):e.jsx("div",{className:"text-center p-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Предварительный просмотр недоступен для этого типа файла"})});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted/50 rounded",children:[e.jsx("span",{className:"text-lg",children:x(o)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:i}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y(v)})]}),e.jsxs("div",{className:"flex gap-1",children:[S(o)&&e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>M(!0),title:"Просмотр",children:e.jsx(De,{size:14})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>window.open(t,"_blank"),title:"Скачать",children:e.jsx(me,{size:14})})]})]}),e.jsx(Pe,{open:p,onOpenChange:M,children:e.jsxs(Fe,{className:"max-w-4xl max-h-[90vh] overflow-hidden",children:[e.jsx(Ue,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Re,{className:"truncate",children:i}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>window.open(t,"_blank"),children:[e.jsx(me,{size:16,className:"mr-1"}),"Скачать"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>M(!1),children:e.jsx(he,{size:16})})]})]})}),e.jsx("div",{className:"overflow-auto",children:j()})]})})]})},ct=({taskId:i,task:t})=>{var C;const{user:o}=pe(),v=d.useRef(null),[p,M]=d.useState(""),[y,x]=d.useState([]),[S,j]=d.useState(!1),[u,k]=d.useState(!1),[F,U]=d.useState(null),{data:L=[],isLoading:_}=as(i),$=rs(),g=L,O=((C=t==null?void 0:t.assignees)==null?void 0:C.some(a=>(typeof a=="string"?a:a._id)===(o==null?void 0:o._id)))||(o==null?void 0:o.role)==="admin"||(o==null?void 0:o.role)==="manager",I=async()=>{if(!p.trim()&&y.length===0){m.error("Добавьте текст или прикрепите файл");return}try{await $.mutateAsync({taskId:i,text:p.trim()||void 0,attachments:y.length>0?y:void 0}),M(""),x([]),m.success("Ответ добавлен")}catch(a){console.error("Error creating response:",a),m.error("Не удалось добавить ответ")}},n=async a=>{if(a.length===0)return;j(!0);const f=[];for(const w of Array.from(a)){if(w.size>50*1024*1024){m.error(`Файл ${w.name} превышает лимит в 50MB`);continue}try{const z=new FormData;z.append("file",w);const T=await fetch("https://api.vazifa.online/api-v1/upload",{method:"POST",body:z,headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!T.ok)throw new Error("Upload failed");const G=await T.json();f.push({fileName:w.name,fileUrl:G.data.secure_url,fileType:w.type,fileSize:w.size})}catch(z){console.error("Upload error:",z),m.error(`Не удалось загрузить файл ${w.name}`)}}x(w=>[...w,...f]),j(!1)},E=a=>{a.target.files&&n(a.target.files)},V=a=>{x(f=>f.filter((w,z)=>z!==a))},Q=async()=>{try{const a=await navigator.mediaDevices.getUserMedia({audio:!0}),f=new MediaRecorder(a),w=[];f.ondataavailable=z=>{w.push(z.data)},f.onstop=async()=>{const z=new Blob(w,{type:"audio/webm"}),T=new File([z],`voice-${Date.now()}.webm`,{type:"audio/webm"}),G=new FormData;G.append("file",T);try{j(!0);const H=await fetch("https://api.vazifa.online/api-v1/upload",{method:"POST",body:G,headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!H.ok)throw new Error("Upload failed");const Y=await H.json();x(r=>[...r,{fileName:"Голосовое сообщение",fileUrl:Y.data.secure_url,fileType:"audio/webm",fileSize:T.size}]),m.success("Голосовое сообщение добавлено")}catch(H){console.error("Voice upload error:",H),m.error("Не удалось загрузить голосовое сообщение")}finally{j(!1)}a.getTracks().forEach(H=>H.stop())},f.start(),U(f),k(!0),m.success("Запись началась...")}catch(a){console.error("Recording error:",a),a instanceof DOMException?a.name==="NotAllowedError"?m.error("Доступ к микрофону запрещен. Разрешите доступ к микрофону в настройках браузера."):a.name==="NotFoundError"?m.error("Микрофон не найден. Подключите микрофон и попробуйте снова."):a.name==="NotReadableError"?m.error("Микрофон занят другим приложением. Закройте другие приложения и попробуйте снова."):a.name==="OverconstrainedError"?m.error("Микрофон не поддерживает требуемые настройки."):a.name==="SecurityError"?m.error("Запись аудио заблокирована по соображениям безопасности. Используйте HTTPS соединение."):m.error("Не удалось начать запись. Проверьте подключение микрофона."):m.error("Не удалось начать запись. Проверьте подключение микрофона.")}},N=()=>{F&&u&&(F.stop(),k(!1),U(null),m.success("Запись остановлена"))},B=a=>{if(a===0)return"0 Bytes";const f=1024,w=["Bytes","KB","MB","GB"],z=Math.floor(Math.log(a)/Math.log(f));return parseFloat((a/Math.pow(f,z)).toFixed(2))+" "+w[z]},W=a=>a.startsWith("image/")?"🖼️":a.startsWith("video/")?"🎥":a.startsWith("audio/")?"🎵":a.includes("pdf")?"📄":a.includes("word")?"📝":a.includes("excel")||a.includes("spreadsheet")?"📊":"📎";return _?e.jsx(xe,{message:"Загрузка ответов..."}):e.jsxs("div",{className:"bg-card rounded-lg p-6 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4",children:["Ответы (",g.length,")"]}),e.jsx(Ee,{className:"h-[300px] mb-4",children:e.jsx("div",{className:"space-y-4",children:g.length>0?g.map(a=>e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(re,{className:"h-8 w-8",children:[e.jsx(ne,{src:a.author.profilePicture||je(a.author.name)}),e.jsx(ie,{children:a.author.name?a.author.name.charAt(0):"?"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:a.author.name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Ne(new Date(a.createdAt),{addSuffix:!0,locale:js})})]}),a.text&&e.jsx("p",{className:"text-sm",children:a.text}),a.attachments&&a.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:a.attachments.map((f,w)=>e.jsx(ot,{fileName:f.fileName,fileUrl:f.fileUrl,fileType:f.fileType||"",fileSize:f.fileSize||0},w))})]})]},a._id)):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground text-sm",children:"Нет ответов"})})})}),O&&e.jsxs(e.Fragment,{children:[e.jsx(Te,{className:"my-4"}),e.jsxs("div",{className:"mt-4",children:[e.jsx(ge,{placeholder:"Добавить ответ...",value:p,onChange:a=>M(a.target.value),className:"mb-2"}),y.length>0&&e.jsx("div",{className:"mb-3 space-y-2",children:y.map((a,f)=>e.jsxs("div",{className:"flex items-center justify-between bg-muted p-2 rounded",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:W(a.fileType)}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:a.fileName}),e.jsx("p",{className:"text-xs text-muted-foreground",children:B(a.fileSize)})]})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>V(f),children:e.jsx(he,{size:16})})]},f))}),e.jsx("input",{ref:v,type:"file",multiple:!0,className:"hidden",onChange:E}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>{var a;return(a=v.current)==null?void 0:a.click()},disabled:S,children:[e.jsx(te,{size:16,className:"mr-1"}),"Файл"]}),e.jsxs(h,{variant:"ghost",size:"sm",onClick:u?N:Q,disabled:S,className:u?"text-red-500":"",children:[e.jsx($e,{size:16,className:"mr-1"}),u?"Стоп":"Голос"]}),S&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"Загрузка..."})]}),e.jsx(h,{onClick:I,disabled:$.isPending||!p.trim()&&y.length===0,children:$.isPending?"Отправляется...":"Отправить ответ"})]})]})]}),!O&&g.length===0&&e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-muted-foreground text-sm",children:"Только назначенные участники могут оставлять ответы на эту задачу"})})]})},dt=i=>{switch(i){case"created_task":return e.jsx("div",{className:"bg-green-600/10 p-2 rounded-md",children:e.jsx(Ae,{className:"h-5 w-5 text-green-600 rounded-full"})});case"created_subtask":return e.jsx("div",{className:"bg-emerald-600/10 p-2 rounded-md",children:e.jsx(Ae,{className:"h-5 w-5 text-emerald-600 rounded-full"})});case"updated_task":case"updated_subtask":return e.jsx("div",{className:"bg-blue-600/10 p-2 rounded-md",children:e.jsx(Fs,{className:"h-5 w-5 text-blue-600 rounded-full"})});case"completed_task":return e.jsx("div",{className:"bg-green-600/10 p-2 rounded-md",children:e.jsx(ue,{className:"h-5 w-5 text-green-600 rounded-full"})});case"created_project":return e.jsx("div",{className:"bg-blue-600/10 p-2 rounded-md",children:e.jsx($s,{className:"h-5 w-5 text-blue-600 rounded-full"})});case"updated_project":return e.jsx("div",{className:"bg-blue-600/10 p-2 rounded-md",children:e.jsx(Ts,{className:"h-5 w-5 text-blue-600 rounded-full"})});case"completed_project":return e.jsx("div",{className:"bg-green-600/10 p-2 rounded-md",children:e.jsx(Ns,{className:"h-5 w-5 text-green-600 rounded-full"})});case"created_workspace":return e.jsx("div",{className:"bg-blue-600/10 p-2 rounded-md",children:e.jsx(Cs,{className:"h-5 w-5 text-blue-600 rounded-full"})});case"added_comment":return e.jsx("div",{className:"bg-blue-600/10 p-2 rounded-md",children:e.jsx(Vs,{className:"h-5 w-5 text-blue-600 rounded-full"})});case"added_member":return e.jsx("div",{className:"bg-blue-600/10 p-2 rounded-md",children:e.jsx(tt,{className:"h-5 w-5 text-blue-600 rounded-full"})});case"removed_member":return e.jsx("div",{className:"bg-red-600/10 p-2 rounded-md",children:e.jsx(et,{className:"h-5 w-5 text-red-600 rounded-full"})});case"joined_workspace":return e.jsx("div",{className:"bg-blue-600/10 p-2 rounded-md",children:e.jsx(Ls,{className:"h-5 w-5 text-blue-600 rounded-full"})});case"added_attachment":return e.jsx("div",{className:"bg-blue-600/10 p-2 rounded-md",children:e.jsx(Xs,{className:"h-5 w-5 text-blue-600 rounded-full"})});default:return null}},mt=({resourceId:i})=>{const[t,o]=d.useState(1),{data:v,isPending:p}=ce({queryKey:["activities",i,t],queryFn:()=>de(`/tasks/${i}/activities?page=${t}`),placeholderData:Ge});if(p)return e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(fe,{className:"animate-spin"})});const{activities:M,pagination:y}=v;return e.jsxs("div",{className:"bg-card rounded-lg p-6 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Активность"}),e.jsx("div",{className:"space-y-4",children:M==null?void 0:M.map(x=>{var S,j;return e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center text-primary",children:dt(x.action)}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:((S=x==null?void 0:x.user)==null?void 0:S.name)||"Неизвестный пользователь"})," ",(j=x==null?void 0:x.details)==null?void 0:j.description]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:Ne(x.createdAt)})]})]},x._id)})}),e.jsx("div",{className:"flex justify-center mt-4",children:e.jsx(h,{variant:"outline",onClick:()=>{t<y.totalPages&&o(t+1)},disabled:t>=y.totalPages,children:"Загрузить больше"})})]})},ut=({watchers:i})=>e.jsxs("div",{className:"bg-card rounded-lg p-6 shadow-sm mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Наблюдатели"}),e.jsx("div",{className:"space-y-2",children:i&&i.length>0?i.map(t=>{var o;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(re,{className:"h-6 w-6",children:[e.jsx(ne,{src:(t==null?void 0:t.profilePicture)||je(t.name)}),e.jsx(ie,{children:((o=t==null?void 0:t.name)==null?void 0:o.charAt(0))||"U"})]}),e.jsx("span",{className:"text-sm",children:(t==null?void 0:t.name)||"Unknown User"})]},t._id)}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет наблюдателей"})})]});function ca(){return[{title:"Vazifa | Детали задачи"},{name:"description",content:"Просмотр деталей задачи в Vazifa!"}]}const xt=()=>{var Y;const{taskId:i}=He();Ke();const{user:t}=pe(),o=Je(),[v,p]=d.useState(!1),[M,y]=d.useState(""),[x,S]=d.useState(""),[j,u]=d.useState(!1),[k,F]=d.useState(""),[U,L]=d.useState(!1),[_,$]=d.useState([]),{data:g,isPending:O,error:I}=ce({queryKey:["task",i],queryFn:()=>de(`/tasks/${i}`),enabled:!!i}),n=g==null?void 0:g.task;g!=null&&g.comments;const E=(g==null?void 0:g.subTasks)||[];ee({mutationFn:r=>ae(`/tasks/${i}/comments`,{content:r}),onSuccess:()=>{o.invalidateQueries({queryKey:["task",i]}),y("")}});const V=ee({mutationFn:r=>ae(`/tasks/${i}/subtasks`,{title:r}),onSuccess:()=>{o.invalidateQueries({queryKey:["task",i]}),S(""),u(!1)}}),Q=ns(),N=ee({mutationFn:()=>ae(`/tasks/${i}/watch`,{}),onSuccess:()=>{p(!v),o.invalidateQueries({queryKey:["task",i]})}}),B=ee({mutationFn:()=>ae(`/tasks/${i}/mark-important`,{}),onSuccess:()=>{o.invalidateQueries({queryKey:["task",i]})}}),W=ee({mutationFn:async r=>{console.log("=== MUTATION FUNCTION DEBUG ==="),console.log("Assignees to send:",r),console.log("URL:",`/api-v1/tasks/${i}/assignees`),console.log("Token:",localStorage.getItem("token")?"Present":"Missing");const A={assignees:r};console.log("Request body:",JSON.stringify(A));const D=await fetch(`/api-v1/tasks/${i}/assignees`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(A)});if(console.log("Response status:",D.status),console.log("Response ok:",D.ok),!D.ok){const J=await D.json();throw console.error("Error response data:",J),new Error(J.message||"Failed to update assignees")}const K=await D.json();return console.log("Success response data:",K),K},onSuccess:r=>{console.log("=== MUTATION SUCCESS ==="),console.log("Success data:",r),o.invalidateQueries({queryKey:["task",i]}),o.refetchQueries({queryKey:["task",i]}),L(!1)},onError:r=>{console.log("=== MUTATION ERROR ==="),console.error("Mutation error:",r),console.error("Error message:",r.message)}}),{data:C}=ce({queryKey:["users"],queryFn:()=>de("/users/all")}),a=()=>{x.trim()&&V.mutate(x)},f=r=>{F(r)},w=()=>{k&&k!==(n==null?void 0:n.status)&&i&&Q.mutate({taskId:i,status:k})};n&&!k&&F(n.status);const z=()=>{var A;const r=((A=n==null?void 0:n.assignees)==null?void 0:A.map(D=>D._id))||[];$(r),L(!0)},T=async()=>{var r;console.log("=== SAVE ASSIGNEES DEBUG ==="),console.log("Current selectedAssignees:",_),console.log("Task ID:",i),console.log("Current task assignees:",(r=n==null?void 0:n.assignees)==null?void 0:r.map(A=>A._id));try{!_||_.length===0?(console.log("Sending empty array"),W.mutate([])):(console.log("Sending assignees:",_),W.mutate(_))}catch(A){console.error("Error in handleSaveAssignees:",A)}},G=r=>{$(A=>A.includes(r)?A.filter(D=>D!==r):[...A,r])},H=()=>"/dashboard/all-tasks";return O?e.jsx(xe,{message:"Загрузка задачи..."}):I||!n?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[400px] space-y-4",children:[e.jsx("h2",{className:"text-2xl font-semibold",children:"Задача не найдена"}),e.jsx("p",{className:"text-muted-foreground",children:"Запрашиваемая задача не существует или была удалена."}),e.jsx(be,{to:H(),children:e.jsxs(h,{children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Вернуться к задачам"]})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(be,{to:H(),children:e.jsxs(h,{variant:"outline",size:"sm",children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Назад к задачам"]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[((t==null?void 0:t.role)==="admin"||(t==null?void 0:t.role)==="super_admin")&&e.jsxs(h,{variant:n.isImportant?"default":"outline",size:"sm",onClick:()=>B.mutate(),disabled:B.isPending,children:[e.jsx(_e,{className:`h-4 w-4 mr-2 ${n.isImportant?"fill-current":""}`}),n.isImportant?"Важная":"Отметить важной"]}),((t==null?void 0:t.role)==="admin"||(t==null?void 0:t.role)==="super_admin"||(t==null?void 0:t.role)==="manager")&&e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>N.mutate(),children:[v?e.jsx(As,{className:"h-4 w-4 mr-2"}):e.jsx(De,{className:"h-4 w-4 mr-2"}),v?"Не следить":"Следить"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-4 lg:gap-6",children:[e.jsxs("div",{className:"xl:col-span-2 space-y-4 lg:space-y-6",children:[e.jsxs(ke,{children:[e.jsx(we,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(at,{title:n.title,taskId:i}),e.jsxs("div",{className:"flex items-center space-x-2 flex-wrap",children:[e.jsx(X,{variant:n.status.toLowerCase(),children:Ce(n.status)}),n.priority&&e.jsxs(X,{variant:n.priority==="High"?"destructive":"secondary",children:[e.jsx(Rs,{className:"h-3 w-3 mr-1"}),us(n.priority)]}),n.isArchived&&e.jsxs(X,{variant:"outline",children:[e.jsx(ws,{className:"h-3 w-3 mr-1"}),"В архиве"]}),n.isImportant&&e.jsxs(X,{variant:"default",className:"bg-yellow-500 hover:bg-yellow-600",children:[e.jsx(_e,{className:"h-3 w-3 mr-1 fill-current"}),"Важная"]})]})]}),((t==null?void 0:t.role)==="admin"||(t==null?void 0:t.role)==="super_admin"||(t==null?void 0:t.role)==="manager")&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(ls,{onValueChange:f,value:k,children:[e.jsx(os,{className:"w-40",children:e.jsx(cs,{})}),e.jsxs(ds,{children:[e.jsx(le,{value:"To Do",children:"К выполнению"}),e.jsx(le,{value:"In Progress",children:"В процессе"}),e.jsx(le,{value:"Done",children:"Выполнено"})]})]}),k!==n.status&&e.jsxs(h,{size:"sm",onClick:w,disabled:Q.isPending,children:[e.jsx(xs,{className:"h-4 w-4 mr-2"}),Q.isPending?"Публикация...":"Опубликовать"]})]})]})}),e.jsxs(Se,{className:"space-y-6",children:[e.jsx(rt,{description:n.description||"",taskId:i}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(vs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"Исполнители:"}),e.jsx("span",{children:n.assignees&&n.assignees.length>0?n.assignees.map(r=>(r==null?void 0:r.name)||"Неизвестный").join(", "):"Не назначены"}),((t==null?void 0:t.role)==="admin"||(t==null?void 0:t.role)==="super_admin"||(t==null?void 0:t.role)==="manager")&&e.jsxs(Pe,{open:U,onOpenChange:L,children:[e.jsx(ms,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-2",onClick:z,children:e.jsx(ve,{className:"h-4 w-4"})})}),e.jsxs(Fe,{className:"sm:max-w-md",children:[e.jsx(Ue,{children:e.jsx(Re,{children:"Редактировать исполнителей"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-3",children:"Выберите участников для назначения на задачу:"}),e.jsx("div",{className:"max-h-60 overflow-y-auto space-y-2 border rounded p-2",children:C?((Y=C==null?void 0:C.users)==null?void 0:Y.length)>0?C.users.map(r=>{var K;const A=(K=n==null?void 0:n.assignees)==null?void 0:K.some(J=>J._id===r._id),D=_.includes(r._id);return e.jsxs("div",{className:"flex items-center space-x-3 p-2 hover:bg-gray-50 rounded",children:[e.jsx("input",{type:"checkbox",id:r._id,checked:D,onChange:()=>G(r._id),className:"rounded w-4 h-4"}),e.jsxs("label",{htmlFor:r._id,className:"flex items-center space-x-2 cursor-pointer flex-1",children:[e.jsx("span",{className:"font-medium",children:r.name}),e.jsx(X,{variant:"outline",className:"text-xs",children:r.role==="admin"?"Админ":r.role==="manager"?"Менеджер":r.role==="super_admin"?"Супер админ":"Участник"}),A&&e.jsx(X,{variant:"secondary",className:"text-xs bg-blue-100 text-blue-800",children:"Назначен"})]})]},r._id)}):(C==null?void 0:C.length)>0?C.map(r=>{var K;const A=(K=n==null?void 0:n.assignees)==null?void 0:K.some(J=>J._id===r._id),D=_.includes(r._id);return e.jsxs("div",{className:"flex items-center space-x-3 p-2 hover:bg-gray-50 rounded",children:[e.jsx("input",{type:"checkbox",id:r._id,checked:D,onChange:()=>G(r._id),className:"rounded w-4 h-4"}),e.jsxs("label",{htmlFor:r._id,className:"flex items-center space-x-2 cursor-pointer flex-1",children:[e.jsx("span",{className:"font-medium",children:r.name}),e.jsx(X,{variant:"outline",className:"text-xs",children:r.role==="admin"?"Админ":r.role==="manager"?"Менеджер":r.role==="super_admin"?"Супер админ":"Участник"}),A&&e.jsx(X,{variant:"secondary",className:"text-xs bg-blue-100 text-blue-800",children:"Назначен"})]})]},r._id)}):e.jsxs("div",{className:"text-center py-4 text-gray-500",children:["Пользователи не найдены",e.jsx("br",{}),e.jsxs("small",{children:["Debug: ",JSON.stringify(C)]})]}):e.jsx("div",{className:"text-center py-4 text-gray-500",children:"Загрузка пользователей..."})}),e.jsxs("div",{className:"flex space-x-2 pt-2",children:[e.jsx(h,{onClick:T,disabled:W.isPending,className:"flex-1",children:W.isPending?"Сохранение...":"Сохранить"}),e.jsx(h,{variant:"outline",onClick:()=>L(!1),className:"flex-1",children:"Отмена"})]})]})]})]})]}),n.responsibleManager&&typeof n.responsibleManager=="object"&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ys,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"Ответственный менеджер:"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[n.responsibleManager.profilePicture&&e.jsx("img",{src:n.responsibleManager.profilePicture,alt:n.responsibleManager.name,className:"h-6 w-6 rounded-full object-cover"}),e.jsx("span",{className:"font-medium text-blue-600",children:n.responsibleManager.name})]})]}),n.dueDate&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(bs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"Срок выполнения:"}),e.jsx("span",{children:oe(n.dueDate)})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ze,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"Создано:"}),e.jsx("span",{children:oe(n.createdAt)})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ze,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"Обновлено:"}),e.jsx("span",{children:oe(n.updatedAt)})]})]})]}),e.jsx(nt,{attachments:n.attachments||[],taskId:i})]})]}),e.jsxs(ke,{children:[e.jsx(we,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(is,{className:"flex items-center",children:[e.jsx(ue,{className:"h-5 w-5 mr-2"}),"Подзадачи (",E.length,")"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>u(!j),children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),"Добавить подзадачу"]})]})}),e.jsxs(Se,{children:[j&&e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsx(se,{placeholder:"Название подзадачи...",value:x,onChange:r=>S(r.target.value),onKeyPress:r=>r.key==="Enter"&&a()}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(h,{size:"sm",onClick:a,disabled:V.isPending,children:"Добавить"}),e.jsx(h,{variant:"outline",size:"sm",onClick:()=>u(!1),children:"Отмена"})]})]}),E.length>0?e.jsx("div",{className:"space-y-2",children:E.map(r=>e.jsxs("div",{className:"flex items-center space-x-2 p-2 border rounded",children:[e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"flex-1",children:r.title}),e.jsx(X,{variant:r.status.toLowerCase(),children:Ce(r.status)})]},r._id))}):e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"Подзадачи отсутствуют"})]})]}),e.jsx(ct,{taskId:i,task:n}),((t==null?void 0:t.role)==="admin"||(t==null?void 0:t.role)==="super_admin"||(t==null?void 0:t.role)==="manager")&&e.jsx(lt,{taskId:i,members:[]})]}),e.jsxs("div",{className:"space-y-4 lg:space-y-6",children:[e.jsx(ut,{watchers:n.watchers||[]}),e.jsx(mt,{resourceId:i})]})]})]})},da=We(xt);export{da as default,ca as meta};
