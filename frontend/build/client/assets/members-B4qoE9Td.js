import{w as ee}from"./with-props-DyG_vBPJ.js";import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{a as j}from"./chunk-D4RADZKF-By21buN-.js";import{t as I}from"./index-CNgNZYQm.js";import{L as se}from"./loader-B2rr_xqw.js";import{A as ae,a as te,b as re}from"./avatar-B8lmOvvi.js";import{B as le}from"./badge-BR4L36Rg.js";import{B as S}from"./button-CYnDp3Q-.js";import{C as c,a as o,b as d,d as m}from"./card-DunmZ-Mm.js";import{D as ne,a as ie,b as ce,d as oe,e as de,c as me}from"./dropdown-menu-C2T7FvO_.js";import{I as xe}from"./input-BPm_T_uW.js";import{S as _,a as B,b as F,c as H,d as l}from"./select-CDLpyc4Q.js";import{S as he,T as ue,a as je,b as k,c as f,d as fe,e as x}from"./table-DP2a9-SM.js";import{D as pe,a as ge,b as Ne,c as we,e as ye,d as ve}from"./dialog-Bw6wHjQP.js";import{f as be}from"./date-utils-BYRQ6yq9.js";import{u as Ce}from"./auth-context-B5vrc64i.js";import{u as q}from"./useQuery-CkwzADaB.js";import{u as De,a as Se,f as E}from"./fetch-utils-CEdl9sdl.js";import{u as ke}from"./useMutation-CUJSGQ7R.js";import{C as Re}from"./circle-alert-CzTjZiAb.js";import{U as Te}from"./users-C3qiH94-.js";import{c as Q}from"./createLucideIcon-DYOGCEiU.js";import{S as R}from"./shield-DZkN-RC5.js";import{U as T}from"./user-DIG-VwFC.js";import{C as Ae}from"./clock-DtXE6-Nx.js";import{C as Me}from"./circle-check-big-CiMFBpoa.js";import{S as Le}from"./settings-WfLMetyi.js";import"./index-CnVBUu3y.js";import"./index-wu72o1Zw.js";import"./index-DTIwNWd2.js";import"./utils-DIzSUSji.js";import"./Combination-BUzufNIs.js";import"./index-BIYj4ebj.js";import"./index-BhFca_hj.js";import"./index-Dspms17g.js";import"./index-BdQq_4o_.js";import"./index-DgMzxt3E.js";import"./differenceInCalendarDays-D7TXt3rl.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]],A=Q("crown",Pe);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]],_e=Q("ellipsis",Ie);function ys({}){return[{title:"TaskHub | Участники"},{name:"description",content:"Управление участниками в TaskHub!"}]}const Be=()=>{const{user:a}=Ce(),U=De(),[N,V]=j.useState(""),[w,z]=j.useState("all"),[h,M]=j.useState(null),[K,p]=j.useState(!1),[L,P]=j.useState("member"),y=(a==null?void 0:a.role)&&["admin","super_admin","manager"].includes(a.role),v=(a==null?void 0:a.role)==="admin"||(a==null?void 0:a.role)==="super_admin",{data:u,isPending:O}=q({queryKey:["all-users"],queryFn:()=>E("/users/all"),enabled:y}),{data:n,isPending:$}=q({queryKey:["all-tasks-for-stats"],queryFn:()=>E("/tasks/all-tasks"),enabled:y}),b=ke({mutationFn:s=>Se(`/admin/users/${s.userId}/role`,{role:s.role}),onSuccess:()=>{I.success("Роль пользователя успешно изменена"),U.invalidateQueries({queryKey:["all-users"]}),p(!1),M(null)},onError:s=>{I.error(s.message||"Ошибка изменения роли")}});if(!y)return e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Re,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Доступ запрещен"}),e.jsx("p",{className:"text-muted-foreground",children:"У вас нет прав для просмотра участников. Обратитесь к администратору."})]})});if(O||$)return e.jsx(se,{message:"Загрузка участников..."});const i=u&&typeof u=="object"&&"users"in u&&Array.isArray(u.users)?u.users:[],G=Array.isArray(n)?n:n&&n.tasks&&Array.isArray(n.tasks)?n.tasks:[],C=new Map;G.forEach(s=>{s.assignees&&s.assignees.forEach(t=>{const r=C.get(t._id)||{total:0,completed:0,inProgress:0,todo:0};r.total++,s.status==="Done"?r.completed++:s.status==="In Progress"?r.inProgress++:s.status==="To Do"&&r.todo++,C.set(t._id,r)})});const D=i.filter(s=>{const t=(s.name||"").toLowerCase().includes(N.toLowerCase())||(s.email||"").toLowerCase().includes(N.toLowerCase()),r=w==="all"||s.role===w;return t&&r}),J=s=>{switch(s){case"admin":return e.jsx(A,{className:"h-4 w-4 text-yellow-600"});case"manager":return e.jsx(R,{className:"h-4 w-4 text-blue-600"});default:return e.jsx(T,{className:"h-4 w-4 text-gray-600"})}},W=s=>{switch(s){case"admin":return"Администратор";case"manager":return"Менеджер";default:return"Участник"}},X=s=>{switch(s){case"admin":return"destructive";case"manager":return"default";default:return"secondary"}},Y=s=>{M(s),P(s.role),p(!0)},Z=()=>{h&&b.mutate({userId:h._id,role:L})},g={total:i.length,admins:i.filter(s=>s.role==="admin").length,managers:i.filter(s=>s.role==="manager").length,members:i.filter(s=>s.role==="member").length};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"Участники"}),e.jsx("p",{className:"text-muted-foreground",children:"Управление участниками и их ролями"})]})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(c,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"Всего участников"}),e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold",children:g.total})})]}),e.jsxs(c,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"Администраторы"}),e.jsx(A,{className:"h-4 w-4 text-yellow-600"})]}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:g.admins})})]}),e.jsxs(c,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"Менеджеры"}),e.jsx(R,{className:"h-4 w-4 text-blue-600"})]}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:g.managers})})]}),e.jsxs(c,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"Участники"}),e.jsx(T,{className:"h-4 w-4 text-gray-600"})]}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-gray-600",children:g.members})})]})]}),e.jsxs(c,{children:[e.jsx(o,{children:e.jsx(d,{children:"Поиск и фильтры"})}),e.jsx(m,{className:"space-y-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(xe,{placeholder:"Поиск по имени или email...",value:N,onChange:s=>V(s.target.value),className:"pl-10"})]})}),e.jsxs(_,{value:w,onValueChange:z,children:[e.jsx(B,{className:"w-full md:w-48",children:e.jsx(F,{placeholder:"Роль"})}),e.jsxs(H,{children:[e.jsx(l,{value:"all",children:"Все роли"}),e.jsx(l,{value:"admin",children:"Администраторы"}),e.jsx(l,{value:"manager",children:"Менеджеры"}),e.jsx(l,{value:"member",children:"Участники"})]})]})]})})]}),e.jsxs(c,{children:[e.jsx(o,{children:e.jsxs(d,{children:["Участники (",D.length," из ",i.length,")"]})}),e.jsx(m,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(ue,{children:[e.jsx(je,{children:e.jsxs(k,{children:[e.jsx(f,{children:"Пользователь"}),e.jsx(f,{children:"Роль"}),e.jsx(f,{children:"Задачи"}),e.jsx(f,{children:"Дата регистрации"}),v&&e.jsx(f,{children:"Действия"})]})}),e.jsxs(fe,{children:[D.map(s=>{const t=C.get(s._id)||{total:0,completed:0,inProgress:0,todo:0};return e.jsxs(k,{children:[e.jsx(x,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ae,{className:"h-10 w-10",children:[e.jsx(te,{src:s.profilePicture}),e.jsx(re,{children:(s.name||"U").charAt(0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name||"Без имени"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.email||"Без email"})]})]})}),e.jsx(x,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[J(s.role||"member"),e.jsx(le,{variant:X(s.role||"member"),children:W(s.role||"member")})]})}),e.jsx(x,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Всего: ",t.total]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-3 w-3 rounded-full bg-blue-600"}),t.todo]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ae,{className:"h-3 w-3 text-yellow-600"}),t.inProgress]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Me,{className:"h-3 w-3 text-green-600"}),t.completed]})]})]})}),e.jsx(x,{children:e.jsx("span",{className:"text-sm text-muted-foreground",children:s.createdAt?be(s.createdAt):"Дата не указана"})}),v&&e.jsx(x,{children:e.jsxs(ne,{children:[e.jsx(ie,{asChild:!0,children:e.jsx(S,{variant:"ghost",size:"sm",children:e.jsx(_e,{className:"h-4 w-4"})})}),e.jsxs(ce,{align:"end",children:[e.jsx(oe,{children:"Действия"}),e.jsx(de,{}),e.jsxs(me,{onClick:()=>Y(s),children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Изменить роль"]})]})]})})]},s._id)}),D.length===0&&e.jsx(k,{children:e.jsx(x,{colSpan:v?5:4,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:"Участников, соответствующих критериям, не найдено"})})})]})]})})})]}),e.jsx(pe,{open:K,onOpenChange:p,children:e.jsxs(ge,{children:[e.jsxs(Ne,{children:[e.jsx(we,{children:"Изменить роль пользователя"}),e.jsxs(ye,{children:["Изменение роли пользователя ",h==null?void 0:h.name]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Новая роль"}),e.jsxs(_,{value:L,onValueChange:s=>P(s),children:[e.jsx(B,{className:"w-full",children:e.jsx(F,{})}),e.jsxs(H,{children:[e.jsx(l,{value:"admin",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-4 w-4 text-yellow-600"}),"Администратор"]})}),e.jsx(l,{value:"manager",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-blue-600"}),"Менеджер"]})}),e.jsx(l,{value:"member",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4 text-gray-600"}),"Участник"]})})]})]})]})}),e.jsxs(ve,{children:[e.jsx(S,{variant:"outline",onClick:()=>p(!1),children:"Отмена"}),e.jsx(S,{onClick:Z,disabled:b.isPending,children:b.isPending?"Изменение...":"Изменить роль"})]})]})})]})},vs=ee(Be);export{vs as default,ys as meta};
