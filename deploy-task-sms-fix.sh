#!/bin/bash

# Deploy Task SMS Fix Script
# Fixes SMS notifications for task creation

set -e  # Exit on error

echo "================================================================================"
echo "üöÄ –î–ï–ü–õ–û–ô –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø SMS –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –û –ó–ê–î–ê–ß–ê–•"
echo "================================================================================"
echo ""

# SSH Configuration
SSH_HOST="ubuntu@193.111.11.98"
SSH_PORT="3022"
BACKEND_DIR="/var/www/vazifa/backend"

echo "üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
echo "   SSH: $SSH_HOST:$SSH_PORT"
echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $BACKEND_DIR"
echo ""

# Test SSH connection
echo "üîå –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
if ! ssh -p "$SSH_PORT" "$SSH_HOST" "echo '‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'" 2>/dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É"
    exit 1
fi
echo ""

# Upload scripts
echo "================================================================================"
echo "üì§ –ó–ê–ì–†–£–ó–ö–ê –°–ö–†–ò–ü–¢–û–í –ù–ê –°–ï–†–í–ï–†"
echo "================================================================================"
echo ""

echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ diagnose-task-sms.js..."
scp -P "$SSH_PORT" backend/diagnose-task-sms.js "$SSH_HOST:$BACKEND_DIR/" || {
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ diagnose-task-sms.js"
    exit 1
}

echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ fix-task-sms-settings.js..."
scp -P "$SSH_PORT" backend/fix-task-sms-settings.js "$SSH_HOST:$BACKEND_DIR/" || {
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ fix-task-sms-settings.js"
    exit 1
}

echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ test-create-task-sms.js..."
scp -P "$SSH_PORT" backend/test-create-task-sms.js "$SSH_HOST:$BACKEND_DIR/" || {
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ test-create-task-sms.js"
    exit 1
}

echo "‚úÖ –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
echo ""

# Run diagnostic
echo "================================================================================"
echo "üîç –®–ê–ì 1: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê"
echo "================================================================================"
echo ""

ssh -p "$SSH_PORT" "$SSH_HOST" << 'ENDSSH'
cd /var/www/vazifa/backend
echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""
node diagnose-task-sms.js
ENDSSH

DIAG_EXIT_CODE=$?
echo ""

if [ $DIAG_EXIT_CODE -ne 0 ]; then
    echo "‚ö†Ô∏è  –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
    echo "   –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º..."
fi

# Fix settings
echo "================================================================================"
echo "üîß –®–ê–ì 2: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–°–¢–†–û–ï–ö"
echo "================================================================================"
echo ""

ssh -p "$SSH_PORT" "$SSH_HOST" << 'ENDSSH'
cd /var/www/vazifa/backend
node fix-task-sms-settings.js
ENDSSH

FIX_EXIT_CODE=$?
echo ""

if [ $FIX_EXIT_CODE -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫"
    exit 1
fi

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
echo ""

# Test task creation
echo "================================================================================"
echo "üß™ –®–ê–ì 3: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–û–ó–î–ê–ù–ò–Ø –ó–ê–î–ê–ß–ò"
echo "================================================================================"
echo ""

ssh -p "$SSH_PORT" "$SSH_HOST" << 'ENDSSH'
cd /var/www/vazifa/backend
node test-create-task-sms.js
ENDSSH

TEST_EXIT_CODE=$?
echo ""

# Final summary
echo "================================================================================"
echo "üìä –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢"
echo "================================================================================"
echo ""

if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–®–õ–ò –£–°–ü–ï–®–ù–û!"
    echo ""
    echo "üéâ SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç!"
    echo ""
    echo "üì± –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:"
    echo "   ‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã"
    echo "   ‚úÖ –í–∫–ª—é—á–µ–Ω—ã SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
    echo "   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø 'task_notification'"
    echo ""
    echo "üîî –¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:"
    echo "   1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é –ø—Ä–∏–¥–µ—Ç SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
    echo "   2. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é –ø—Ä–∏–¥–µ—Ç Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
    echo "   3. –°–æ–∑–¥–∞—Å—Ç—Å—è in-app —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
    echo ""
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:"
    echo "   https://protocol.oci.tj/dashboard/all-tasks"
else
    echo "‚ö†Ô∏è  –¢–ï–°–¢–´ –ó–ê–í–ï–†–®–ò–õ–ò–°–¨ –° –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø–ú–ò"
    echo ""
    echo "üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "   - –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∞"
    echo "   - SMPP —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "   - –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB"
    echo ""
    echo "üìã –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
    echo "   ssh -p $SSH_PORT $SSH_HOST"
    echo "   cd $BACKEND_DIR"
    echo "   node diagnose-task-sms.js"
    echo ""
    echo "üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ PM2 –ª–æ–≥–∏:"
    echo "   ssh -p $SSH_PORT $SSH_HOST 'pm2 logs vazifa-backend --lines 50'"
fi

echo "================================================================================"
echo ""

exit $TEST_EXIT_CODE
