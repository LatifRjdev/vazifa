#!/bin/bash

# SMS Delayed Test Deployment Script
# This script uploads and runs the delayed SMS test on the server

set -e  # Exit on error

echo "================================================================================"
echo "üì± –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–î–ï–†–ñ–ê–ù–ù–û–ì–û SMS –¢–ï–°–¢–ê"
echo "================================================================================"
echo ""

# SSH Configuration
SSH_HOST="ubuntu@193.111.11.98"
SSH_PORT="3022"
BACKEND_DIR="/var/www/vazifa/backend"

echo "üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
echo "   SSH: $SSH_HOST:$SSH_PORT"
echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $BACKEND_DIR"
echo ""

# Test SSH connection
echo "üîå –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
if ! ssh -p "$SSH_PORT" "$SSH_HOST" "echo '‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'" 2>/dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É"
    exit 1
fi
echo ""

# Upload test script
echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp -P "$SSH_PORT" backend/test-delayed-sms.js "$SSH_HOST:$BACKEND_DIR/" || {
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª"
    exit 1
}
echo "‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: test-delayed-sms.js"
echo ""

# Run the test on the server
echo "================================================================================"
echo "üöÄ –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê –ù–ê –°–ï–†–í–ï–†–ï"
echo "================================================================================"
echo ""
echo "üì± –û—Ç–ø—Ä–∞–≤–∫–∞ SMS:"
echo "   1. +992557777509 (–ø–µ—Ä–≤–æ–µ SMS)"
echo "   2. –û–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥..."
echo "   3. +992985343331 (–≤—Ç–æ—Ä–æ–µ SMS)"
echo ""
echo "================================================================================"
echo ""

# Execute the test script via SSH
ssh -p "$SSH_PORT" "$SSH_HOST" << 'ENDSSH'
cd /var/www/vazifa/backend

echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""

# Check if .env exists
if [ ! -f .env ]; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "   –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
    echo ""
fi

# Run the test
echo "üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞..."
echo ""

node test-delayed-sms.js

EXIT_CODE=$?

echo ""
echo "================================================================================"
if [ $EXIT_CODE -eq 0 ]; then
    echo "‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û"
else
    echo "‚ùå –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù –° –û–®–ò–ë–ö–û–ô (–∫–æ–¥: $EXIT_CODE)"
fi
echo "================================================================================"

exit $EXIT_CODE
ENDSSH

TEST_EXIT_CODE=$?

echo ""
echo "================================================================================"
echo "üìä –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°"
echo "================================================================================"

if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "‚úÖ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    echo "üì± –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã:"
    echo "   - +992557777509 (–¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ SMS \"–¢–µ—Å—Ç\")"
    echo "   - +992985343331 (–¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ SMS \"–¢–µ—Å—Ç\" —á–µ—Ä–µ–∑ ~30 —Å–µ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ)"
    echo ""
else
    echo "‚ùå –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏"
    echo ""
    echo "üîç –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "   1. PM2 –ª–æ–≥–∏:"
    echo "      ssh -p $SSH_PORT $SSH_HOST 'pm2 logs vazifa-backend --lines 50'"
    echo "   2. SMPP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:"
    echo "      ssh -p $SSH_PORT $SSH_HOST 'cd $BACKEND_DIR && node test-delayed-sms.js'"
    echo "   3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ $BACKEND_DIR/.env"
    echo ""
fi

echo "================================================================================"
echo ""

exit $TEST_EXIT_CODE
